-v0.1 2025.10.7  Sherlock init
-v0.2 2025.11.22 Sherlock ...

简介：使用本文持续整理ARM MPAM协议的相关内容，分析依据MPAM spec A.a。


需求
-----

现代服务器上运行多个用户的多个程序，硬件资源是共享的。我们可以通过类似cgroup的技
术对共享的硬件资源做调控，比如cgroup可以调控CPU和内存等资源。但是诸如cache使用、
内存带宽使用，软件难以直接做调控，这就需要引入新硬件，软件通过新硬件提供的接口做
资源调控。ARM上引入MPAM(memory partition and monitor)对内存相关的资源做控制和监
测。

对应的内存相关资源有：1. cache；2. 内部总线；3. 内存。控制的角度有：1. 使用大小；
2. 优先级；3. ？

概念和模型
-----------

MPAM使用一个全局唯一的三元组标记每个内存访问的源头，对于PE，这些信息需要配置到
MPAMx_ELn相关系统寄存器里，可以看到如果partition ID的语意就是PE本身，配置一次就
好，如果partition ID表示线程，就需要在线程切换的时候更新这个配置。在cache/内存控制器/
SMMU上增加MPAM控制节点(MSC(memory system compoment))，节点提供MMIO寄存器接口，这
些接口接受三元组的资源控制和监控的配置。相关配置提前配置好，系统运行的时候，访问
cache或者内存的请求根据提前配置的信息进行资源控制和监控。

注意，现代处理器实现都采用流水线技术，在单点控制相当于控制流水线中的一个点，容易
引发系统问题。另外，一旦系统里有共享部件，硬件逻辑综合起来就容易冲突，也可能引发
问题。

三元组的三个元素是：partition ID space，partition ID，PMG(performance monitor group)。
partition ID space是安全态，主要用partition ID区分资源类型，PMG用来聚集一组监测
资源。

MSC集成在各个内存相关的部件里，由专门的ACPI或者DTS MPAM表格报给OS。(todo: ...)

MPAM协议里还定义了一些MPAM内部传递控制信息的概念(第四章)，感觉这些概念以及相关的
部件是软件较少感知的。

MPAM协议里简单描述了下硬件内部partitioning control的逻辑，简单讲就是当前使用的资
源和提前配置好的资源不断的做比较，如果还有余量就给分资源，反之就不给分资源。更近
一步看，capacity-based partitioning才需要这种动态调整，portion-based partitioning
(比如，直接配置可以用哪几个cache way的情况)的调整逻辑就可以比较简单。

可以看到硬件内部会用表格记录各种资源配置，如果这个表格在硬件内部，那么这个部件在
使用中有低功耗的上下电动作时，这些内容都要做保存和恢复。




MPAM只有两种类型中断：1. 报告错误的中断；2. monitor计数溢出中断。

resource partitioning control
-------------------------------

MPAMCFG_CASSOC,     Cache Maximum Associativity Partition

MPAMCFG_CMAX,       Cache Maximum Capacity Partition
配置cache使用的最大百分比

MPAMCFG_CMIN,       Cache Minimum Capacity Partition
配置cache使用的最小百分比，小于这个百分比的partition ID的优先级被提高，优先分
cache。

MPAMCFG_CPBM<n>,    Cache Portion Bitmap Partition
按照portion的配置寄存器。配置的方式: 1. 最大bit数，2. select出要配置的partition
ID，3. 执行配置。这东西每个partition ID都配置一把，很难看到一个综合的结构啊？
有接口到处目前配置的所有策略么?


MPAMCFG_MBW_MAX,    Memory Bandwidth Maximum Partition
MPAMCFG_MBW_MIN,    Memory Bandwidth Minimum Partition
MPAMCFG_MBW_PBM<n>, Bandwidth Portion Bitmap Partition 
MPAMCFG_MBW_PROP,   Memory Bandwidth Proportional Stride Partition
MPAMCFG_MBW_WINWD,  Memory Bandwidth Partitioning Window Width 

MPAMCFG_PRI,        Priority Partition
todo: 怎么搞的优先级？

resource monitor
------------------

(todo: ...)

软件实现
---------

MPAM对外使用resctrl文件系统作为接口。

以openEuler为例，驱动代码在drivers/platform/mpam/。这个驱动是一个平台设备驱动，
但是但是真正probe的地方在注册的cpu online的会调函数里。

resctrl和驱动的借口似乎是直接arch实现函数调用的... 如此粗暴...

寄存器
-------

软件需要配置MSC上各种资源的配置，这些配置用partition ID和RIS做标记，RIS(resource
instance selection)里resource value是啥？
软件需要用MPAMCFG_PART_SEL选择当前要配置的partition ID和RIS。

todo: cache行为


